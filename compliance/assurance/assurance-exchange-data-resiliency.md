---
title: Microsoft 365 での Exchange Online データの回復性
description: この記事では、Exchange Online および Microsoft 365 内のデータ復元のさまざまな側面について説明します。
ms.author: robmazz
author: robmazz
manager: laurawi
ms.reviewer: sosstah
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Strat_O365_IP
- M365-security-compliance
- MS-Compliance
f1.keywords:
- NOCSH
ms.custom: seo-marvel-apr2020
titleSuffix: Microsoft Service Assurance
hideEdit: true
ms.openlocfilehash: 4782cb47bcd5da86daf11f01cb3a443a9b637c49
ms.sourcegitcommit: 024137a15ab23d26cac5ec14c36f3577fd8a0cc4
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/01/2021
ms.locfileid: "51497211"
---
# <a name="exchange-online-data-resiliency-in-microsoft-365"></a>Microsoft 365 での Exchange Online データの復元

>[!IMPORTANT]
>メールボックス コンテンツを保持するためのさまざまな方法に投資を続ける中で、Exchange Online の exchange 管理センター (EAC) での In-Place Holds の削除を発表します。 2020 年 7 月 1 日から、新しい保留リストをIn-Placeできます。 ただし、EAC で、または Exchange Online PowerShell In-Place **Set-MailboxSearch** コマンドレットを使用して、引き続き保留リストを管理できます。 ただし、2020 年 10 月 1 日から、保留の管理In-Placeされます。 削除できるのは、EAC または **Remove-MailboxSearch コマンドレットを使用する場合** のみです。 このIn-Place Exchange ハイブリッド展開Exchange Server保持の使用は引き続きサポートされます。 Exchange Online での保留リストの削除のIn-Placeについては、「従来の電子情報開示ツールの使用を取り除く [」を参照してください](/microsoft-365/compliance/legacy-ediscovery-retirement)。

インプレース保持では、削除済みアイテムと変更されたアイテムの元のバージョンを含む、すべてのメールボックスのコンテンツが保持されます。 [In-Place eDiscovery](/exchange/security-and-compliance/in-place-ediscovery/in-place-ediscovery) 検索で、このようなメールボックスのすべてのアイテムが返されます。 In-Place 保持をユーザーのメールボックスに配置すると、対応するアーカイブ メールボックス内のコンテンツ (有効な場合) も保留にされ、電子情報開示検索で返されます。

Exchange データベースに影響を与える可能性のある破損には、通常、ハードウェア (特にストレージ ハードウェア) の問題によって引き起こされる物理的な破損と、他の要因によって発生する論理的な破損の 2 種類があります。 一般に、Exchange データベース内で発生する可能性がある論理破損には、次の 2 種類があります。

- **データベースの論理破損** - データベース ページのチェックサムが一致しますが、ページ上のデータが論理的に間違っています。 これは、データベース エンジン (拡張記憶域エンジン (ESE)) がデータベース ページの書き込みを試み、オペレーティング システムが成功メッセージを返しても、データがディスクに書き込まれたり、間違った場所に書き込まれたりしない場合に発生することがあります。 これは、*ロスト フラッシュ* と呼ばれます。 ESE には、データベースの物理的な破損や他のデータ損失のシナリオを防ぐために設計された多数の機能とセーフガードが含まれています。 失われたフラッシュがデータを失うのを防ぐため、ESE には、データベースに失われたフラッシュ検出メカニズムと、それを修正する機能 (単一ページの復元) が含まれています。
- **ストアの論理破損** - ユーザーが期待しない方法でデータが追加、削除、または操作されます。 これらのケースは、サード パーティ製のアプリケーションによって発生します。 ユーザーが破損と見なすという意味では、通常は破損です。 Exchange ストアは、論理的破損を引き起こすトランザクションを一連の有効な MAPI 操作として見なします。 Exchange Online のインプレイス [保持](/exchange/security-and-compliance/create-or-remove-in-place-holds) 機能は、ストアの論理的な破損からの保護を提供します (ユーザーまたはアプリケーションによってコンテンツが完全に削除されるのを防ぐため)。 

Exchange Online は、ログ インスペクションとログ再生の両方で、レプリケートされたログ ファイルに対していくつかの整合性チェックを実行します。 これらの整合性チェックは、物理的な破損がシステムによってレプリケートされるのを防ぐためです。 たとえば、ログ 検査中に、ログ ファイルを検証し、ログ ファイルに記録されたチェックサムがメモリで生成されたチェックサムと一致する検証を行う物理的整合性チェックがあります。 さらに、ログ ファイル ヘッダーが調べ、ログ ヘッダーに記録されたログ ファイルの署名がログ ファイルの署名と一致する必要があります。 ログの再生中に、ログ ファイルはさらに精査されます。 たとえば、データベース ヘッダーには、ログ ファイルの署名と比較して一致するログ署名も含まれています。 

Exchange Online でのメールボックス データの破損に対する保護は、Exchange Native Data Protection を使用して実現されます。これは、複数のサーバーおよび複数のデータセンター間でのアプリケーション レベルのレプリケーションと、破損などの理由によりデータが失われるのを防う他の機能を活用する復元戦略です。 これらの機能には、Microsoft または Exchange Online アプリケーション自体によって管理されるネイティブ機能が含まれます。次に示します。

- [データ可用性グループ](/exchange/back-up-email)
- 単一ビットの修正 
- オンライン データベースのスキャン 
- 失われたフラッシュ検出 
- 単一ページの復元 
- メールボックス レプリケーション サービス 
- ログ ファイルのチェック 
- 復元可能なファイル システムでの展開 

前に示したネイティブ機能の詳細については、ハイパーリンクを選択し、ハイパーリンクのないアイテムの追加情報と詳細については、以下を参照してください。 これらのネイティブ機能に加えて、Exchange Online には、次のような、お客様が管理できるデータ復元機能も含まれています。 
- [単一アイテムの回復 (既定で有効)](/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages) 
- [インプレース保持と訴訟ホールド](/exchange/security-and-compliance/in-place-and-litigation-holds) 
- [削除済みアイテムの保持Soft-Deletedメールボックス (両方とも既定で有効)](/exchange/recipients-in-exchange-online/delete-or-restore-mailboxes) 

## <a name="database-availability-groups"></a>データベース可用性グループ 
Microsoft 365 のすべてのメールボックス データベースは、データベース可用性グループ [(DAG)](/exchange/back-up-email) でホストされ、同じ地域内の地理的に分離されたデータセンターにレプリケートされます。 最も一般的な構成は、4 つのデータセンター内の 4 つのデータベース コピーです。ただし、データセンターが少ない地域があります (データベースはインドの 3 つのデータセンターと、オーストラリアと日本の 2 つのデータセンターにレプリケートされます)。 ただし、すべてのメールボックス データベースには、複数のデータセンターに分散された 4 つのコピーが含まれており、これにより、メールボックス データがソフトウェア、ハードウェア、データセンターの障害から確実に保護されます。 

これら 4 つのコピーの中で、3 つのコピーが高可用性として構成されています。 4 番目のコピーは、時間差データベース [コピーとして構成されます](/Exchange/high-availability/manage-ha/activate-lagged-db-copies)。 時間差データベース コピーは、個々のメールボックスの回復やメールボックス アイテムの回復を意図したコピーではありません。 その目的は、システム全体の壊滅的な論理的破損のまれなイベントに対する回復メカニズムを提供します。 

Exchange Online の遅延データベース コピーは、7 日間のログ ファイル再生ラグ タイムで構成されます。 さらに、Exchange 再生ラグ マネージャーを有効にすると、ログ ファイルの拡大を自己修復および管理するための遅延データベース コピーを許可するために、遅延コピーの動的ログ ファイル再生を提供できます。 Exchange Online では、時間差データベース コピーが使用されます。ただし、これらのコピーが保証されたポイントインタイム バックアップではないと理解することが重要です。 Exchange Online の時間差データベース コピーの可用性のしきい値は、ディスク障害によりディスクに時間差コピーが含まれるディスクが失われる期間、(自動再生が原因で) 可用性の高いコピーになる期間、および時間差データベース コピーがログ再生キューを再構築する期間が原因で、通常は約 90% です。 

## <a name="transport-resilience"></a>トランスポートの復元 
Exchange Online には、シャドウ冗長とセーフティ ネットの 2 つの主なトランスポート復元機能が含まれています。 Shadow Redundancy は、メッセージの転送中にメッセージの冗長コピーを保持します。 セーフティ ネットは、メッセージが正常に配信された後、メッセージの冗長コピーを保持します。 

シャドウ冗長では、各 Exchange Online トランスポート サーバーは、送信側サーバーへのメッセージの正常な受信を確認する前に、受信した各メッセージのコピーを作成します。 これにより、転送中にトランスポート パイプライン内のすべてのメッセージが冗長になります。 Exchange Online が転送中に元のメッセージが失われたと判断した場合、メッセージの冗長コピーが再提供されます。 

セーフティ ネットは、メールボックス サーバー上のトランスポート サービスに関連付けられているトランスポート キューです。 このキューにより、サーバーによって正常に処理されたメッセージのコピーが保存されます。 メールボックス データベースまたはサーバーの障害がメールボックス データベースの古いコピーをアクティブ化する必要がある場合、セーフティ ネット キュー内のメッセージは、メールボックス データベースの新しいアクティブ コピーに自動的に再送信されます。 セーフティ ネットも冗長化され、単一障害点としてトランスポートが排除されます。 プライマリ セーフティ ネットとシャドウ セーフティ ネットの概念を使用します。プライマリ セーフティ ネットが 12 時間以上使用できない場合、再送信要求はシャドウ再送信要求になり、メッセージはシャドウ セーフティ ネットから再提供されます。

セーフティ ネットからのメッセージの再送信は、DAG とメールボックス データベース コピーを管理する Microsoft Exchange Replication サービスの Active Manager コンポーネントによって自動的に開始されます。 セーフティ ネットからメッセージを再送信するには、手動で操作する必要はありません。 

## <a name="single-bit-correction"></a>単一ビットの修正 
ESE には、ハードウェア エラー (および物理的な破損を表す) の結果である単一ビット CRC エラー (シングル ビット フリップとも呼ばれる) を検出して解決するメカニズムが含まれています。 これらのエラーが発生すると、ESE は自動的にエラーを修正し、イベント ログにイベントを記録します。 

## <a name="online-database-scanning"></a>オンライン データベースのスキャン 
オンライン データベース スキャン (データベース チェックの *合計とも呼* ばれる) は、ESE がデータベース整合性チェッカーを使用して各ページを読み取り、ページの破損を確認するプロセスです。 主な目的は、トランザクション操作によって検出されない可能性のある物理的な破損と失われたフラッシュを検出します。 データベース スキャンでは、ストア後のクラッシュ操作も実行されます。 クラッシュにより領域が漏洩する可能性があります。オンライン データベースのスキャンでは、失われた領域を検出して回復します。 システムは、すべてのデータベースが 7 日に 1 回完全にスキャンされるという期待を持って設計されています。 

## <a name="lost-flush-detection"></a>失われたフラッシュ検出 
フラッシュが失われたのは、完了として返されたディスク サブシステム/オペレーティング システムが実際にディスクに書き込まれたか、間違った場所に書き込まれたデータベース書き込み操作である場合に発生します。 フラッシュが失われた場合、データベースの論理的な破損が発生する可能性があります。そのため、失われたフラッシュがデータの失われを防ぐため、ESE には失われたフラッシュ検出メカニズムが含まれています。 データベース ページがパッシブ コピーに書き込まれると、アクティブ コピーのフラッシュが失われた場合にチェックが実行されます。 フラッシュが失われた場合、ESE はページの修正プロセスを使用してプロセスを修復できます。 

## <a name="single-page-restore"></a>単一ページの復元 
単一ページの復元 (ページの修正プログラムとも呼ばれる) は、破損したデータベース ページが正常なレプリカからの正常なコピーに置き換えられる自動プロセスです。 破損したページの修復プロセスは、データベース コピーがアクティブかパッシブかによって異なります。 アクティブなデータベース コピーで破損したページが検出された場合、コピーするページが最新の状態である場合は、そのレプリカの 1 つからページをコピーできます。 このプロセスは、メールボックス データベースレプリケーションの基礎であるログ ストリームにページの要求を入れて実行します。 レプリカはページ要求を検出するとすぐに、要求するデータベース コピーにページのコピーを送信して応答します。 単一ページの復元では、レプリカが現在オフラインである場合でも、アクティブなユーザーがレプリカからページを要求するための非同期通信メカニズムも提供します。 

これらのコピーは常にアクティブ コピーの背後にあるため、データベース コピーの時間差を含むパッシブ データベース コピーが破損した場合、アクティブ コピーからパッシブ コピーに任意のページをコピーしても安全です。 パッシブ データベース コピーは、性質上高可用性なので、ページの修正プロセス中はログの再生は中断されますが、ログ コピーは続行されます。 パッシブ データベース コピーは、破損したページのコピーをアクティブ コピーから取得し、必要なログ生成の最大要件を満たすログ ファイルがコピーおよび検査されるまで待機し、破損したページにパッチを適用します。 ページにパッチが適用されると、ログ再生が再開されます。 このプロセスは、時間差データベース コピーでも同じですが、更新可能な状態を達成するために必要なすべてのログ ファイルが最初に再生されます。 

## <a name="mailbox-replication-service"></a>メールボックス レプリケーション サービス 
メールボックスの移動は、大規模なメール サービスを管理する重要な部分です。 常に更新されたテクノロジとハードウェアとバージョンのアップグレードに対処するために、堅牢で調整されたシステムを使用して、エンジニアがメールボックスをユーザーに対して透過的に移動しながら (プロセス全体を通じてオンラインに保つことによって) この作業を実行できるシステムが重要であり、メールボックスの規模が大きくなるとプロセスが正常にスケールアップします。 

Exchange メールボックス レプリケーション サービス (MRS) は、データベース間でメールボックスを移動する責任があります。 移動中、MRS はメールボックス内のすべてのアイテムに対して整合性チェックを実行します。 一貫性の問題が見つかった場合、MRS は問題を修正するか、破損したアイテムをスキップしてメールボックスから破損を削除します。 

MRS は Exchange Online のコンポーネントなので、将来検出される新しい形式の破損に対処するためにコードを変更できます。 たとえば、MRS が修正できない一貫性の問題が検出された場合は、破損を分析し、MRS コードを変更し、不整合を修正できます (方法がわかっている場合)。 

## <a name="log-file-checks"></a>ログ ファイルのチェック 
Exchange データベースによって生成されたトランザクション ログ ファイルはすべて、いくつかの形式の整合性チェックを受け取ります。 ログ ファイルが作成されると、最初に行われるのはビット パターンが書き込まれた後、一連のログ書き込みを実行することです。 この構造により、Exchange Online は一連のチェック (フラッシュ、CRC、その他のチェックが失われた) を実行して、書き込まれた各ログ ファイルを検証し、レプリケート時に再度検証できます。 

## <a name="deployment-on-resilient-file-system"></a>復元可能なファイル システムでの展開 
ファイル システム レベルで破損が発生するのを防ぐために、回復機能を強化するために、Exchange Online は復元ファイル システム (ReFS) パーティションに展開されています。 ReFS は、Windows Server 2012以降のファイル システムであり、データの破損に対する回復力を高め、データの可用性と整合性を最大化するように設計されています。 具体的には、ReFS はメタデータの更新方法が改善され、データの保護が強化され、データ破損のケースが減少します。 また、チェックサムを使用してファイル データとメタデータの整合性を確認し、データの破損が簡単に見つかり、修復できます。 

Exchange Online では、いくつかの ReFS の利点を利用できます。 
- データの整合性に対する復元性が高いということは、データ破損インシデントの数が少なさを意味します。 破損インシデントの数を減らすと、不要なデータベースの再表示が少なくなっています。 
- メタデータで実行されるチェックサムにより、破損ケースの検出が早く、より早く、より詳細に行われるため、データ ボリュームで灰色のエラーが発生する前に顧客データの破損を修正できます。
- パフォーマンスに影響を与えることなく、大規模なデータ セット (ペタバイト以上) でうまく機能するように設計されています。
- BitLocker 暗号化など、Exchange Online で使用されるその他の機能のサポート。 

Exchange Online には、他の ReFS 機能も利用できます。 
- **整合性 (Integrity Streams)** - ReFS は、通常はデータ損失を引き起こす可能性がある多くの一般的なエラーからデータを保護する方法でデータを格納します。 Microsoft 365 Search は、整合性ストリームを使用して、ファイル コンテンツの初期ディスク破損検出とチェックサムを支援します。 また、"Torn Write" (停電などによって書き込み操作が完了しない場合) によって発生する破損インシデントも軽減されます。 
- **可用性 (Salvage)** - ReFS はデータの可用性を優先します。 これまで、ファイル システムは、修復のためにシステムをオフラインにする必要があるデータ破損の影響を受けやすいことが多かった。 まれですが、破損が発生した場合、ReFS は、ライブ ボリューム上の名前空間から破損したデータを削除し、修復できない破損データによって適切なデータが悪影響を受けずに行われるよう、サルベージ機能を実装します。 Salvage 機能を適用し、データの破損を Exchange Online データベース ボリュームに分離すると、破損と修復アクションの間に、影響を受けないデータベースを破損したボリュームに正常に保持できます。 この構造により、通常、このようなディスク破損の問題の影響を受けるデータベースの可用性が向上します。 
