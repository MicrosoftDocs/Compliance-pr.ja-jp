---
title: Microsoft 365 での Exchange Online データの回復性
description: この記事では、Exchange Online と Microsoft 365 でのデータの復元のさまざまな側面について説明します。
ms.author: robmazz
author: robmazz
manager: laurawi
ms.reviewer: sosstah
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Strat_O365_IP
- M365-security-compliance
- MS-Compliance
f1.keywords:
- NOCSH
ms.custom: seo-marvel-apr2020
titleSuffix: Microsoft Service Assurance
ms.openlocfilehash: 801bac11d7f9ee377aaa4082bdab8dde533ce177
ms.sourcegitcommit: 626b0076d133e588cd28598c149a7f272fc18bae
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/30/2020
ms.locfileid: "49507866"
---
# <a name="exchange-online-data-resiliency-in-microsoft-365"></a>Microsoft 365 での Exchange Online データの復元

Exchange データベースに影響を与える可能性がある破損には、次の2種類があります。物理的な破損は、通常、ハードウェア (特にストレージハードウェア) の問題、およびその他の要因によって発生する論理的な破損に起因します。 通常、Exchange データベース内で発生する可能性がある論理的な破損には、次の2種類があります。

- **データベースの論理破損** -データベースページのチェックサムは一致しますが、ページ上のデータが論理的に間違っています。 これは、データベースエンジン (拡張記憶エンジン (ESE)) がデータベースページを作成しようとしたときに、オペレーティングシステムが成功メッセージを返した場合、データがディスクに書き込まれていないか、または正しくない場所に書き込まれている場合に発生する可能性があります。 これは、*ロスト フラッシュ* と呼ばれます。 ESE には、データベースやその他のデータ損失シナリオの物理的な破損を防止するために設計されたさまざまな機能と安全対策が用意されています。 失われたデータを失わないようにするため、ESE にはデータベース内の失われたフラッシュ検出メカニズムと機能 (単一ページ復元) が含まれています。
- **ストレージの論理破損** -ユーザーが期待できない方法でデータが追加、削除、または操作されます。 これらのケースは、サードパーティ製のアプリケーションが原因で発生します。 通常、ユーザーが破損しているように表示されるという意味があります。 Exchange ストアは、論理的破損を引き起こすトランザクションを一連の有効な MAPI 操作として見なします。 Exchange Online の [インプレース保持](https://docs.microsoft.com/exchange/security-and-compliance/create-or-remove-in-place-holds) 機能により、ストアの論理的破損を防止できます (ユーザーまたはアプリケーションによってコンテンツが完全に削除されることはないため)。 

Exchange Online は、ログ検査およびログ再生の両方で、レプリケートされたログファイルに対して複数の整合性チェックを実行します。 これらの整合性チェックによって、システムによって物理的破損がレプリケートされるのを防ぐことができます。 たとえば、ログ検査時には、ログファイルを検証し、ログファイルに記録されたチェックサムがメモリに生成されたチェックサムと一致することを確認する物理的な整合性チェックがあります。 さらに、ログヘッダーに記録されたログファイルの署名がログファイルの内容と一致することを確認するために、ログファイルヘッダーが検査されます。 ログ再生中に、ログファイルはさらに精査されます。 たとえば、データベースヘッダーには、ログファイルの署名と比較して、一致していることを確認するためのログ署名も含まれています。 

Exchange Online のメールボックスデータの破損に対する保護は、Exchange ネイティブデータ保護を使用することによって実現されます。これは、複数のサーバーと複数のデータセンター間でアプリケーションレベルのレプリケーションを利用する復元戦略と、破損またはその他の理由によりデータが失われないように保護するための機能です。 これらの機能には、次のような Microsoft または Exchange Online アプリケーション自体によって管理されるネイティブ機能が含まれます。

- [データ可用性グループ](https://docs.microsoft.com/exchange/back-up-email)
- シングルビット修正 
- オンラインデータベーススキャン 
- 失われたフラッシュの検出 
- 単一ページの復元 
- メールボックスレプリケーションサービス 
- ログファイルのチェック 
- 弾性ファイルシステムへの展開 

前述のネイティブ機能の詳細については、ハイパーリンクを選択し、ハイパーリンクのない項目の詳細については、次を参照してください。 これらのネイティブ機能に加えて、Exchange Online には、お客様が管理できるデータ復元機能もあります。次のようなものがあります。 
- [単一アイテムの回復 (既定では有効)](https://docs.microsoft.com/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages) 
- [インプレース保持と訴訟ホールド](https://docs.microsoft.com/exchange/security-and-compliance/in-place-and-litigation-holds) 
- [削除済みアイテムの保存期間と Soft-Deleted メールボックス (既定で有効)](https://docs.microsoft.com/exchange/recipients-in-exchange-online/delete-or-restore-mailboxes) 

## <a name="database-availability-groups"></a>データベース可用性グループ 
Microsoft 365 のすべてのメールボックスデータベースは、 [データベース可用性グループ (DAG)](https://docs.microsoft.com/exchange/back-up-email) でホストされ、同じ地域内の地理的に離れたデータセンターにレプリケートされます。 最も一般的な構成は、4つのデータセンター内の4つのデータベースコピーです。ただし、地域によっては、データセンターの数が少ない (インドの3つのデータセンターにデータベースがレプリケートされ、オーストラリアと日本では2つのデータセンターにレプリケートされる) 場合があります。 ただし、すべてのメールボックスデータベースには、複数のデータセンターに分散された4つのコピーがあるため、メールボックスのデータがソフトウェア、ハードウェア、およびデータセンターの障害から保護されています。 

これらの4つのコピーのうち3つは高可用性として構成されています。 4番目のコピーは、 [時間差データベースコピー](https://docs.microsoft.com/Exchange/high-availability/manage-ha/activate-lagged-db-copies)として構成されます。 時間差データベースコピーは、個々のメールボックスの回復またはメールボックスのアイテムの回復を目的としたものではありません。 この目的は、システム全体に重大な致命的な破損が発生した場合に備えて回復メカニズムを提供することです。 

Exchange Online の時間差データベースコピーは、7日間のログファイル再生ラグタイムで構成されます。 さらに、Exchange 再生ラグマネージャーは、時間差コピーに対して動的ログファイルの再生を有効にして、時間差データベースコピーを自己修復し、ログファイルの拡張を管理できるようにします。 Exchange Online では時間差データベースコピーが使用されていますが、ポイントインタイムのバックアップが保証されているわけではないことを理解しておくことが重要です。 Exchange Online の時間差データベースコピーには可用性のしきい値があり、90通常は、時間差コピーが格納されているディスクがディスク障害によって失われる期間 (自動再生のため)、および時間差データベースコピーがログ再生キューを再構築している期間によって、時間差コピーが、高可用性コピーになります。 

## <a name="transport-resilience"></a>トランスポートの復元性 
Exchange Online には、シャドウ冗長とセーフティネットという2つの主要なトランスポート復元機能があります。 シャドウ冗長は、送信中のメッセージの冗長コピーを保持します。 セーフティネットは、メッセージが正常に配信された後に、メッセージの冗長コピーを保持します。 

シャドウ冗長性を使用すると、各 Exchange Online トランスポートサーバーは、メッセージを送信側サーバーに正常に受信する前に、受信した各メッセージのコピーを作成します。 これにより、トランスポートパイプライン内のすべてのメッセージが送信中に冗長化されます。 Exchange Online で送信中に元のメッセージが失われたことが確認されると、メッセージの冗長コピーが再配信されます。 

セーフティネットは、メールボックスサーバー上のトランスポートサービスに関連付けられているトランスポートキューです。 このキューにより、サーバーによって正常に処理されたメッセージのコピーが保存されます。 メールボックスデータベースまたはサーバーの障害が、メールボックスデータベースの古いコピーをアクティブにする必要がある場合、セーフティネットキュー内のメッセージは、メールボックスデータベースの新しいアクティブコピーに自動的に再送信されます。 セーフティネットは冗長でもあるため、単一障害点としてのトランスポートが不要になります。 プライマリセーフティネットとシャドウセーフティネットの概念を使用して、プライマリセーフティネットが12時間以上利用できない場合、再送信要求がシャドウ再送信要求になり、メッセージがシャドウセーフティネットから再配信されるというようになります。

セーフティネットからのメッセージの再送信は、Dag およびメールボックスデータベースコピーを管理する Microsoft Exchange Replication サービスのアクティブマネージャーコンポーネントによって自動的に開始されます。 セーフティネットからメッセージを再送信するために手動での操作は必要ありません。 

## <a name="single-bit-correction"></a>シングルビット修正 
ESE には、ハードウェアエラーの結果である (または物理的な破損を示す) 単一ビット CRC エラー (単一ビットフリップとも呼ばれる) を検出して解決するメカニズムが含まれています。 これらのエラーが発生すると、ESE はそれらを自動的に修正し、イベントログにイベントを記録します。 

## <a name="online-database-scanning"></a>オンラインデータベーススキャン 
オンラインデータベーススキャン ( *データベース確認の集計* とも呼ばれます) は、ESE がデータベース整合性チェッカーを使用して各ページを読み取り、ページが破損しているかどうかを確認するプロセスです。 主な目的は、トランザクション操作によって検出されない可能性がある物理的な破損および失われたフラッシュを検出することです。 データベーススキャンは、ストアのクラッシュ後のクラッシュ操作も実行します。 クラッシュによって領域がリークし、オンラインデータベーススキャンによって失われた領域が検出され、回復されることがあります。 システムは、すべてのデータベースが7日ごとに完全にスキャンされることを想定して設計されています。 

## <a name="lost-flush-detection"></a>失われたフラッシュの検出 
ディスクサブシステムまたはオペレーティングシステムが完了として返されたデータベース書き込み操作が実際にディスクに書き込まれなかったか、正しくない場所に書き込まれたときに、破損フラッシュが発生します。 失われたフラッシュインシデントはデータベースの論理的な破損につながる可能性があるため、データの損失を回避するために、ESE に失われたフラッシュ検出メカニズムが用意されています。 データベースページがパッシブコピーに書き込まれると、アクティブコピーの失われたフラッシュに対してチェックが実行されます。 失われたフラッシュが検出されると、ESE はページパッチ処理を使用してプロセスを修復できます。 

## <a name="single-page-restore"></a>単一ページの復元 
単一ページの復元 ( *ページパッチ* とも呼ばれます) は、破損したデータベースページが正常なレプリカからの正常なコピーに置き換えられる自動プロセスです。 破損したページの修復プロセスは、データベースコピーがアクティブであるかパッシブであるかによって異なります。 アクティブデータベースコピーは、破損したページを検出すると、ページが最新の状態になっていれば、そのレプリカの1つからページをコピーできます。 このプロセスは、ページの要求をログストリームに配置することによって行われます。これは、メールボックスデータベースのレプリケーションの基礎となります。 レプリカがページ要求を検出するとすぐに、要求元のデータベースコピーにページのコピーを送信することによって応答します。 また、単一ページの復元では、レプリカが現在オフラインであっても、レプリカからページを要求するためにアクティブな非同期通信メカニズムも提供されます。 

時間差データベースコピーを含むパッシブデータベースコピーが破損した場合、これらのコピーは常にアクティブコピーの背後にあるため、アクティブコピーからパッシブコピーに任意のページをコピーするのは常に安全です。 パッシブデータベースコピーは自然に高可用性のため、ページのパッチ処理中にログの再生は中断されますが、ログのコピーは続行されます。 パッシブデータベースコピーは、アクティブなコピーから破損したページのコピーを取得し、必要なログ生成の最大要件を満たすログファイルがコピーおよび検査されるまで待機してから、破損したページを更新します。 ページにパッチが適用されると、ログ再生が再開します。 このプロセスは、時間差データベースコピーの場合と同じですが、時間差データベースは、最初に patchable 状態を実現するために必要なすべてのログファイルを再生する点が異なります。 

## <a name="mailbox-replication-service"></a>メールボックスレプリケーションサービス 
メールボックスの移動は、大規模なメールサービスを管理するための重要な部分です。 常に更新されたテクノロジとハードウェアおよびバージョンのアップグレードがあります。これにより、エンジニアがこの作業を行うことができ、(プロセス全体をオンライン状態にしていることを確認することにより) メールボックスの移動をユーザーに対して透過的に保持することができます。 

Exchange メールボックスレプリケーションサービス (MR) は、データベース間でメールボックスを移動する役割を担います。 移行中、MR はメールボックス内のすべてのアイテムに対して整合性チェックを実行します。 整合性の問題が検出された場合は、問題を解決するか、破損したアイテムをスキップして、メールボックスの破損を回避することができます。 

お客様は、お客様が Exchange Online のコンポーネントであるため、今後検出される新しい形式の破損に対処するために、コードに変更を加えることができます。 たとえば、問題を解決できないという一貫性の問題が検出された場合は、破損を分析し、MR コードを変更して、矛盾を修正します (方法を理解している場合)。 

## <a name="log-file-checks"></a>ログファイルのチェック 
Exchange データベースによって生成されたすべてのトランザクションログファイルには、いくつかの形式の整合性チェックが行われます。 ログファイルが作成されると、最初に行うことはビットパターンを作成してから、一連のログ書き込みを実行するということです。 この構造を使用すると、Exchange Online は一連のチェック (破損したフラッシュ、CRC、その他のチェック) を実行して、書き込まれた各ログファイルを検証したり、レプリケートされたときに再び検証したりできます。 

## <a name="deployment-on-resilient-file-system"></a>弾性ファイルシステムへの展開 
ファイルシステムレベルで破損が発生しないようにするために、Exchange Online は回復機能を強化するために、復元可能なファイルシステム (ReFS) パーティションに展開されています。 ReFS は、データ破損に対する復元性を向上させるために設計された Windows Server 2012 以降のファイルシステムで、データの可用性と整合性を最大限に高めます。 具体的には、メタデータの更新方法が向上し、データの保護が向上し、データ破損のケースが減少します。 また、チェックサムを使用して、ファイルデータの整合性と、データの破損が容易に検出および修復されることを確認します。 

Exchange Online は、次に示すいくつかの参照の利点を活用しています。 
- データ整合性の復元性が向上すると、データ破損インシデントが減少します。 破損インシデントの数を減らすと、不要なデータベースの再シードが減少します。 
- メタデータで実行されているチェックサムにより、破損のケースをより早く検出できるようになり、データボリュームでグレイエラーが発生する前に、顧客データの破損を修正できるようになります。
- 大きなデータセット (ペタバイト以上) に対応しており、パフォーマンスに影響を与えないように設計されている
- Exchange Online で使用されるその他の機能のサポート (BitLocker 暗号化など)。 

Exchange Online には、他の ReFS 機能によるメリットもあります。 
- **整合性 (整合性ストリーム)** -ReFS は、通常、データ損失が発生する多くの一般的なエラーからデータを保護する方法でデータを格納します。 Microsoft 365 Search は、整合性ストリームを使用して、ファイルコンテンツの早期のディスク破損検出およびチェックサムを支援します。 また、この機能により、"欠落書き込み" によって発生する破損インシデントが減少します (停電などのために書き込み操作が完了しなかった場合)。 
- **Availability (Salvage)** -ReFS は、データの可用性の優先順位を示します。 従来は、ファイルシステムがデータ破損の影響を受けやすくなり、修復のためにシステムをオフラインにする必要がありました。 まれに破損が発生した場合、ReFS は salvage を実装します。この機能は、ライブボリューム上の名前空間から破損したデータを削除し、修復できない破損データによって良好なデータが悪影響を受けないようにする機能です。 Salvage 機能を適用し、データ破損を Exchange Online データベースボリュームに分離することは、破損した状態と修復処理の間に影響を受けないデータベースを破損したボリュームに保持できることを意味します。 この構造では、通常はディスク破損の問題の影響を受けるデータベースの可用性が向上します。 