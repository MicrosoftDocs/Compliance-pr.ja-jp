---
title: Microsoft 365 での Exchange Online データの回復性
description: この記事では、Exchange Online と Microsoft 365 内のデータ復元のさまざまな側面について説明します。
ms.author: robmazz
author: robmazz
manager: laurawi
ms.reviewer: sosstah
audience: ITPro
ms.topic: article
ms.service: O365-seccomp
localization_priority: Normal
search.appverid:
- MET150
ms.collection:
- Strat_O365_IP
- M365-security-compliance
- MS-Compliance
f1.keywords:
- NOCSH
ms.custom: seo-marvel-apr2020
titleSuffix: Microsoft Service Assurance
ms.openlocfilehash: 044bd637241c566a5e44df6522fca4dcab8b8534
ms.sourcegitcommit: 21ed42335efd37774ff5d17d9586d5546147241a
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/05/2021
ms.locfileid: "50120526"
---
# <a name="exchange-online-data-resiliency-in-microsoft-365"></a>Microsoft 365 での Exchange Online データの復元

>[!IMPORTANT]
>メールボックスのコンテンツを保持するためのさまざまな方法で投資を続ける中で、Exchange Online の Exchange 管理センター (EAC) で In-Place 保留リストが削除されたと発表しています。 2020 年 7 月 1 日から、新しい保留リストIn-Place作成できます。 ただし、EAC で、または Exchange Online PowerShell In-Place **Set-MailboxSearch** コマンドレットを使用して、引き続き保留リストを管理できます。 ただし、2020 年 10 月 1 日から、保留を管理In-Placeで。 削除できるのは、EAC または **Remove-MailboxSearch** コマンドレットを使用する場合のみです。 ハイブリッドIn-Place Exchange ハイブリッドExchange Server保留の使用は引き続きサポートされます。 Exchange Online の保留リストのサポートIn-Placeについては、「従来の電子情報開示ツールのサポートのサポート」 [を参照してください](/microsoft-365/compliance/legacy-ediscovery-retirement)。

インプレース保持では、削除済みアイテムと変更されたアイテムの元のバージョンを含む、すべてのメールボックスのコンテンツが保持されます。 [In-Place eDiscovery](/exchange/security-and-compliance/in-place-ediscovery/in-place-ediscovery) 検索で、このようなメールボックスのすべてのアイテムが返されます。 ユーザーのメールボックスに In-Place ホールドを設定すると、対応するアーカイブ メールボックス (有効な場合) の内容も保持の設定され、電子情報開示検索で返されます。

Exchange データベースに影響を与える可能性がある破損には、物理的な破損の 2 種類があります。物理的な破損は、通常、ハードウェア (特にストレージ ハードウェア) の問題によって発生し、論理的な破損は他の要因によって発生します。 一般に、Exchange データベース内で発生する可能性がある論理的破損には、次の 2 種類があります。

- **データベースの論理的破損** - データベース ページのチェックサムが一致しますが、ページ上のデータが論理的に間違っています。 これは、データベース エンジン (Extensible Storage Engine (ESE) がデータベース ページの書き込みを試み、オペレーティング システムが成功メッセージを返した場合でも、データがディスクに書き込まれたり、正しい場所に書き込まれたりしない場合に発生する可能性があります。 これは、*ロスト フラッシュ* と呼ばれます。 ESE には、データベースの物理的な破損や他のデータ損失シナリオを防止するために設計された多数の機能と保護機能が含まれています。 失われたフラッシュでデータが失われるのを防ぐため、ESE には、データを修正する機能 (単一ページの復元) と共に、失われたフラッシュ検出メカニズムがデータベースに組み込まれています。
- **ストアの論理的破損** - ユーザーが期待しない方法でデータが追加、削除、または操作されます。 このような場合は、サード パーティ製のアプリケーションが原因です。 通常は、ユーザーが破損と見なすという意味での破損です。 Exchange ストアは、論理的破損を引き起こすトランザクションを一連の有効な MAPI 操作として見なします。 Exchange Online のイン [Place Hold](/exchange/security-and-compliance/create-or-remove-in-place-holds) 機能は、ストアの論理的破損からの保護を提供します (ユーザーまたはアプリケーションによってコンテンツが完全に削除されるのを防ぐため)。 

Exchange Online は、ログ検査とログ再生の両方で、レプリケートされたログ ファイルに対していくつかの整合性チェックを実行します。 これらの整合性チェックにより、物理的な破損がシステムによってレプリケートされるのを防ぐ。 たとえば、ログ検査中に、ログ ファイルを検証し、ログ ファイルに記録されたチェックサムがメモリ内で生成されたチェックサムと一致する検証を行う物理的な整合性チェックがあります。 また、ログ ファイル ヘッダーを調べて、ログ ヘッダーに記録されたログ ファイル署名がログ ファイルの署名と一致する必要があります。 ログ再生中、ログ ファイルはさらに調査を受ける。 たとえば、データベース ヘッダーには、ログ ファイルの署名と比較して一致するログ署名も含まれます。 

Exchange Online のメールボックス データの破損に対する保護は、Exchange Native Data Protection を使用して実現されます。これは、複数のサーバーと複数のデータセンター間でアプリケーション レベルのレプリケーションを利用する復元戦略と、破損などの理由でデータが失われからデータが失われるのを防止する機能を活用します。 これらの機能には、Microsoft または Exchange Online アプリケーション自体によって管理されるネイティブ機能が含まれます。次のようなものがあります。

- [データ可用性グループ](/exchange/back-up-email)
- 単一ビットの修正 
- オンライン データベース スキャン 
- 失われたフラッシュ検出 
- 単一ページの復元 
- Mailbox Replication サービス 
- ログ ファイルのチェック 
- Resilient File System での展開 

前に示したネイティブ機能の詳細については、ハイパーリンクを選択し、ハイパーリンクのないアイテムの詳細と追加情報については、以下を参照してください。 これらのネイティブ機能に加えて、Exchange Online には、お客様が管理できるデータ復元機能も含まれています。次に例を示します。 
- [単一アイテムの回復 (既定で有効)](/exchange/recipients-in-exchange-online/manage-user-mailboxes/recover-deleted-messages) 
- [インプレース保持と訴訟ホールド](/exchange/security-and-compliance/in-place-and-litigation-holds) 
- [削除済みアイテムの保存Soft-Deletedメールボックス (両方とも既定で有効)](/exchange/recipients-in-exchange-online/delete-or-restore-mailboxes) 

## <a name="database-availability-groups"></a>データベース可用性グループ 
Microsoft 365 のすべてのメールボックス データベースは、データベース可用性グループ [(DAG)](/exchange/back-up-email) でホストされ、同じ地域内の地理的に離れたデータセンターにレプリケートされます。 最も一般的な構成は、4 つのデータセンターに 4 つのデータベース コピーです。ただし、一部の地域ではデータセンターが少ない (データベースはインドの 3 つのデータセンターにレプリケートされ、オーストラリアと日本の 2 つのデータセンターにレプリケートされます)。 ただし、すべてのメールボックス データベースには、複数のデータセンターに分散された 4 つのコピーがあります。これにより、メールボックス データがソフトウェア、ハードウェア、およびデータセンターの障害から確実に保護されます。 

これら 4 つのコピーの 3 つが高可用性として構成されています。 4 番目のコピーは、時間差データベース [コピーとして構成されます](/Exchange/high-availability/manage-ha/activate-lagged-db-copies)。 時間差データベース コピーは、個々のメールボックスの回復またはメールボックス アイテムの回復には使用されません。 その目的は、システム全体で致命的な論理的破損が発生するまれなイベントの回復メカニズムを提供します。 

Exchange Online の時間差データベース コピーは、7 日間のログ ファイル再生ラグ タイムで構成されます。 さらに、Exchange 再生ラグ マネージャーを有効にすると、時間差コピーに対して再生される動的ログ ファイルを提供し、時間差データベース コピーを自己修復してログ ファイルの拡大を管理できます。 時間差データベース コピーは Exchange Online で使用しますが、これらは保証された時点のバックアップではないと理解することが重要です。 Exchange Online の時間差データベース コピーには、ディスク障害により時間差コピーを含むディスクが失われる期間、時間差コピーが高可用性コピー (自動再生による) になる期間、および時間差データベース コピーがログ再生キューを再構築する期間が原因で、通常約 90% の空き時間情報のしきい値があります。 

## <a name="transport-resilience"></a>トランスポートの復元 
Exchange Online には、シャドウ冗長とセーフティ ネットの 2 つの主要なトランスポート復元機能が含まれています。 シャドウ冗長は、メッセージの送信中にメッセージの冗長コピーを保持します。 セーフティ ネットは、メッセージが正常に配信された後、メッセージの冗長コピーを保持します。 

シャドウ冗長では、各 Exchange Online トランスポート サーバーは、送信側サーバーへのメッセージの正常な受信を確認する前に、受信した各メッセージのコピーを作成します。 これにより、トランスポート パイプライン内のすべてのメッセージが送信中に冗長になります。 Exchange Online が転送中に元のメッセージが失われたと判断した場合、メッセージの冗長コピーが再送信されます。 

セーフティ ネットは、メールボックス サーバー上のトランスポート サービスに関連付けられているトランスポート キューです。 このキューにより、サーバーによって正常に処理されたメッセージのコピーが保存されます。 メールボックス データベースまたはサーバー障害がメールボックス データベースの古いコピーをアクティブ化する必要がある場合、セーフティ ネット キュー内のメッセージはメールボックス データベースの新しいアクティブ コピーに自動的に再送信されます。 セーフティ ネットも冗長化され、トランスポートが単一障害点として排除されます。 プライマリ セーフティ ネットとシャドウ セーフティ ネットの概念を使用します。プライマリ セーフティ ネットが 12 時間以上使用できない場合、再送信要求はシャドウ再送信要求になり、メッセージはシャドウ セーフティ ネットから再送信されます。

セーフティ ネットからのメッセージの再送信は、DAG とメールボックス データベース コピーを管理する Microsoft Exchange Replication サービスのアクティブ マネージャー コンポーネントによって自動的に開始されます。 セーフティ ネットからメッセージを再送信するために、手動による操作は必要ありません。 

## <a name="single-bit-correction"></a>単一ビットの修正 
ESE には、ハードウェア エラー (および物理的な破損を表す) の結果である単一ビット CRC エラー (シングル ビット フリップとも呼ばれる) を検出して解決するメカニズムが用意されています。 これらのエラーが発生すると、ESE はエラーを自動的に修正し、イベント をイベント ログに記録します。 

## <a name="online-database-scanning"></a>オンライン データベース スキャン 
オンライン データベース スキャン (データベース チェックの合計とも呼 *ばれる)* は、ESE がデータベース整合性チェックを使用して各ページを読み取り、ページの破損を確認するプロセスです。 主な目的は、トランザクション操作で検出されない可能性がある物理的な破損と失われたフラッシュを検出します。 データベース スキャンは、ストア後のクラッシュ操作も実行します。 クラッシュが原因で領域がリークし、オンライン データベースのスキャンによって失われた領域が検出および回復される可能性があります。 システムは、すべてのデータベースが 7 日ごとに 1 回完全にスキャンされるという期待を持って設計されています。 

## <a name="lost-flush-detection"></a>失われたフラッシュ検出 
失われたフラッシュは、ディスク サブシステム/オペレーティング システムが完了として返したデータベース書き込み操作が、実際にはディスクに書き込まれたり、間違った場所に書き込まれたりした場合に発生します。 フラッシュ インシデントが失われると、データベースの論理的破損が発生する可能性があります。したがって、失われたフラッシュがデータの失われを防ぐため、ESE には失われたフラッシュ検出メカニズムが組み込まれています。 データベース ページがパッシブ コピーに書き込まれると、アクティブ コピーで失われたフラッシュのチェックが実行されます。 失われたフラッシュが検出された場合、ESE はページパッチ プロセスを使用してプロセスを修復できます。 

## <a name="single-page-restore"></a>単一ページの復元 
単一ページの復元 (ページパッチとも呼ばれる) は、破損したデータベース ページが正常なレプリカからの正常なコピーに置き換えられる自動プロセスです。 破損したページの修復プロセスは、データベース コピーがアクティブかパッシブかによって異なります。 アクティブデータベース コピーが破損したページを検出した場合、コピーするページが最新の状態である場合は、そのレプリカの 1 つからページをコピーできます。 このプロセスは、メールボックス データベースレプリケーションの基礎となるログ ストリームにページの要求を入れて実行します。 レプリカは、ページ要求を検出するとすぐに、要求側のデータベース コピーにページのコピーを送信することで応答します。 単一ページの復元では、レプリカが現在オフラインの場合でも、アクティブがレプリカからページを要求するための非同期通信メカニズムも提供されます。 

時間差データベース コピーを含むパッシブ データベース コピーが破損した場合、これらのコピーは常にアクティブ コピーの背後にあるため、アクティブ コピーからパッシブ コピーにページをコピーしても安全です。 パッシブ データベース コピーは、この性質上高可用性を備えたデータベース コピーなので、ページ パッチプロセス中はログ再生が中断されますが、ログ コピーは続行されます。 パッシブ データベース コピーは、破損したページのコピーをアクティブ コピーから取得し、必要な最大ログ生成要件を満たすログ ファイルがコピーおよび検査されるまで待機し、破損したページを修正します。 ページにパッチが適用されると、ログ再生が再開されます。 時間差データベース コピーの処理は同じですが、時間差データベースは最初に、パッチ可能な状態を実現するために必要なすべてのログ ファイルを再生します。 

## <a name="mailbox-replication-service"></a>Mailbox Replication サービス 
メールボックスの移動は、大規模な電子メール サービスを管理する上で重要な部分です。 常に更新されたテクノロジとハードウェアとバージョンのアップグレードが対応しています。そのため、エンジニアがメールボックスの移動を (プロセス全体を通じてオンラインに保つことによって) ユーザーに対して透過的に移動しながら、この作業を実現できる堅牢で調整されたシステムを用意する必要があります。また、メールボックスの規模が大きくなるとプロセスが正常にスケール アップされるのを確認する必要があります。 

Exchange メールボックス レプリケーション サービス (MRS) は、データベース間でメールボックスを移動します。 移動中に、MRS はメールボックス内のすべてのアイテムに対して整合性チェックを実行します。 一貫性の問題が見つかった場合、MRS は問題を修正するか、破損したアイテムをスキップして、メールボックスから破損を削除します。 

MRS は Exchange Online のコンポーネントなので、今後検出される新しい形式の破損に対処するためにコードを変更できます。 たとえば、MRS が修正できない一貫性の問題が検出された場合は、破損を分析し、MRS コードを変更し、不整合を修正できます (その方法を理解している場合)。 

## <a name="log-file-checks"></a>ログ ファイルのチェック 
Exchange データベースによって生成されるトランザクション ログ ファイルはすべて、いくつかの形式の整合性チェックを受ける。 ログ ファイルが作成されると、最初にビット パターンが書き込まれた後、一連のログ書き込みが実行されます。 この構造体により、Exchange Online は一連のチェック (失われたフラッシュ、CRC、その他のチェック) を実行して、書き込まれた各ログ ファイルを検証し、レプリケート時に再度検証できます。 

## <a name="deployment-on-resilient-file-system"></a>Resilient File System での展開 
ファイル システム レベルで破損が発生するのを防ぐために、Exchange Online は Resilient File System (ReFS) パーティションに展開され、回復機能が強化されています。 ReFS は、Windows Server 2012 以降のファイル システムであり、データの破損に対してより弾力性が高く、データの可用性と整合性を最大化するように設計されています。 具体的には、ReFS では、メタデータの更新方法が改善され、データの保護が向上し、データ破損のケースが軽減されます。 また、チェックサムを使用して、ファイル データとメタデータの整合性を検証し、データの破損を簡単に検出して修復できます。 

Exchange Online には、いくつかの ReFS の利点があります。 
- データ整合性の回復性が向上すると、データ破損インシデントが少なくなっています。 破損インシデントの数を減らすと、不要なデータベース再処理の回数が減るという意味です。 
- メタデータに対して実行されるチェックサムにより、破損事例の検出を早く、より早く、より開始的に行えるので、データ ボリュームで灰色のエラーが発生する前に、顧客データの破損を修正できます。
- パフォーマンスに影響を与えることなく、大規模なデータ セット (ペタバイト以上) で十分に機能するように設計されています。
- BitLocker 暗号化など、Exchange Online で使用されるその他の機能のサポート。 

Exchange Online には、他の ReFS 機能の利点があります。 
- **整合性 (整合性ストリーム)** - ReFS は、通常はデータ損失を引き起こす可能性がある多くの一般的なエラーからデータを保護する方法でデータを格納します。 Microsoft 365 Search は、整合性ストリームを使用して、初期ディスク破損検出とファイル コンテンツのチェックサムを支援します。 また、"Torn Writes" (書き込み操作が停電などによって完了しない場合) によって発生する破損インシデントも削減されます。 
- **可用性 (Salvage)** - ReFS はデータの可用性を優先します。 これまで、ファイル システムはデータの破損の影響を受けやすく、修復のためにシステムをオフラインにする必要があります。 まれに、破損が発生した場合、ReFS は回復を実装します。この機能は、ライブ ボリューム上の名前空間から破損データを削除し、修復できない破損データによる良好なデータの悪影響を受け防止します。 Salvage 機能を適用し、データの破損を Exchange Online データベース ボリュームに分離すると、破損したボリューム上の影響を受けないデータベースは、破損と修復の処理の間に正常な状態を維持できます。 この構造により、通常、このようなディスク破損の問題の影響を受けるデータベースの可用性が向上します。 
